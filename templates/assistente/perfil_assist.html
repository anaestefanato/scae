<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCAE - Meu Perfil</title>
    <link rel="icon" type="image/png" href="/static/img/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/dashboard_assistente.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .info-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .info-card:hover {
            transform: translateY(-2px);
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
        }
        .change-password-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }
        .change-password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="close-sidebar" id="closeSidebar">
                <i class="bi bi-x-lg"></i>
            </button>
            <img src="/static/img/logoifes.png" alt="Logo SCAE" width="180">
        </div>
        <div class="d-flex flex-column p-3">
            <div class="mb-4 text-center">
                <h6 class="mb-0">Sistema de Controle de</h6>
                <h6>Assistência Estudantil</h6>
            </div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="/assistente/inicio" class="nav-link">
                        <i class="bi bi-speedometer2"></i> <span>Início</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/analise-inscricoes" class="nav-link">
                        <i class="bi bi-clipboard-check"></i> <span>Análise de Inscrições</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/analise-recursos" class="nav-link">
                        <i class="bi bi-journal-text"></i> <span>Análise de Recursos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/alunos" class="nav-link">
                        <i class="bi bi-people"></i> <span>Alunos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/entrevistas" class="nav-link">
                        <i class="bi bi-file-earmark-text"></i> <span>Entrevistas Agendadas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/relatorios" class="nav-link">
                        <i class="bi bi-file-earmark-bar-graph"></i> <span>Relatórios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/agenda" class="nav-link">
                        <i class="bi bi-calendar-event"></i> <span>Agenda</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/assistente/perfil" class="nav-link active bg-success">
                        <i class="bi bi-person-circle"></i> <span>Meu Perfil</span>
                    </a>
                </li>
            </ul>
            <hr>
            <div class="text-center">
                <a href="/logout" class="btn btn-outline-danger">
                    <i class="bi bi-box-arrow-right"></i> <span>Sair</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Meu Perfil</h4>
        </div>

        <!-- Alert messages -->
        <script>
            // Verificar parâmetros de URL para exibir mensagens
            const urlParams = new URLSearchParams(window.location.search);
            const sucesso = urlParams.get('sucesso');
            const erro = urlParams.get('erro');
            
            if (sucesso === 'senha_alterada') {
                document.addEventListener('DOMContentLoaded', function() {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Senha alterada com sucesso!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.profile-card'));
                });
            }
            
            if (erro) {
                document.addEventListener('DOMContentLoaded', function() {
                    let mensagem = '';
                    switch(erro) {
                        case 'senha_incorreta':
                            mensagem = 'Senha atual incorreta. Verifique e tente novamente.';
                            break;
                        case 'senhas_diferentes':
                            mensagem = 'As novas senhas não coincidem.';
                            break;
                        case 'senha_pequena':
                            mensagem = 'A nova senha deve ter pelo menos 6 caracteres.';
                            break;
                        case 'erro_servidor':
                            mensagem = 'Erro interno do servidor. Tente novamente.';
                            break;
                        default:
                            mensagem = 'Ocorreu um erro. Tente novamente.';
                    }
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-circle me-2"></i>
                        ${mensagem}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.profile-card'));
                });
            }
        </script>

        <!-- Profile Header Card -->
        <div class="profile-card">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="/static/img/perfil.png" alt="Foto do Perfil" class="profile-avatar">
                </div>
                <div class="col-md-9">
                    <h3 class="mb-1">{{ assistente.nome }}</h3>
                    <p class="mb-1 opacity-75">Assistente Social</p>
                    <p class="mb-0 opacity-75">SIAPE: {{ assistente.matricula }}</p>
                </div>
            </div>
        </div>

        <!-- Profile Information -->
        <div class="row">
            <div class="col-md-8">
                <div class="info-card card h-100">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="mb-0">
                            <i class="bi bi-person-fill text-primary me-2"></i>
                            Informações do Perfil
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <strong>Nome Completo:</strong>
                            </div>
                            <div class="col-sm-9">
                                {{ assistente.nome }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <strong>Matrícula SIAPE:</strong>
                            </div>
                            <div class="col-sm-9">
                                {{ assistente.matricula }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <strong>E-mail:</strong>
                            </div>
                            <div class="col-sm-9">
                                {{ assistente.email }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <strong>Senha:</strong>
                            </div>
                            <div class="col-sm-9">
                                ••••••••••
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-card card h-100">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-lock text-success me-2"></i>
                            Segurança
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="bi bi-key fs-1 text-success mb-3"></i>
                        <p class="text-muted mb-3">
                            Mantenha sua conta segura alterando sua senha regularmente.
                        </p>
                        <button type="button" class="btn change-password-btn" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="bi bi-key me-2"></i>
                            Alterar Senha
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Alteração de Senha -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="bi bi-key me-2"></i>
                        Alterar Senha
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="changePasswordForm" action="/assistente/alterar-senha" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            Por segurança, você precisa confirmar sua senha atual antes de definir uma nova.
                        </div>
                        
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="bi bi-lock me-1"></i>
                                Senha Atual
                            </label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="bi bi-key me-1"></i>
                                Nova Senha
                            </label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                            <div class="form-text">A senha deve ter pelo menos 6 caracteres.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="bi bi-check-circle me-1"></i>
                                Confirmar Nova Senha
                            </label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Alterar Senha
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/sidebar.js"></script>
    <script>
        // Validação do formulário de alteração de senha
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            // Validar se as senhas coincidem
            if (newPassword !== confirmPassword) {
                alert('As senhas não coincidem. Por favor, verifique e tente novamente.');
                return;
            }
            
            // Validar tamanho mínimo da senha
            if (newPassword.length < 6) {
                alert('A nova senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            // Se chegou até aqui, submeter o formulário
            this.submit();
        });
    </script>
</body>
</html>